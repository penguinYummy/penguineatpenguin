<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>순공 시간 타이머</title>
    
    <style>
        /* --- 기본 및 전역 스타일 --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            padding: 20px;
            background-color: #f4f7f6; 
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
        }

        /* --- 주요 컨테이너 레이아웃 --- */
        .timer-app-container {
            display: flex;
            width: 90%;
            max-width: 1200px; /* 넓게 설정 */
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-top: 20px;
        }

        /* --- 타이머 및 버튼 영역 (좌측/중앙) --- */
        .main-timer-section {
            flex: 3;
            padding: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        /* 총 공부 시간 표시 */
        #total-study-display {
            font-size: 1.5em;
            font-weight: 600;
            color: #3498db;
            margin-bottom: 20px;
        }

        /* 현재 타이머 표시 */
        #timer-display {
            font-size: 6em; 
            font-family: monospace; 
            color: #2c3e50;
            letter-spacing: 5px; 
            margin: 20px 0;
            padding: 10px 0;
        }
        
        /* 버튼 스타일 */
        button {
            padding: 12px 30px;
            font-size: 1.2em;
            font-weight: 600;
            margin: 10px 8px;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #start-button {
            background-color: #2ecc71; color: white;
        }
        #start-button:hover:not(:disabled) { background-color: #27ae60; }

        #stop-button {
            background-color: #f39c12; color: white;
        }
        #stop-button:hover:not(:disabled) { background-color: #e67e22; }

        #finish-button {
            background-color: #e74c3c; color: white;
        }
        #finish-button:hover:not(:disabled) { background-color: #c0392b; }
        
        button:disabled {
            background-color: #bdc3c7; color: #7f8c8d; cursor: not-allowed;
            box-shadow: none;
        }

        /* --- 날짜 기록 바 섹션 (우측 고정) --- */
        .date-record-bar-section {
            flex: 1;
            background-color: #ecf0f1;
            padding: 15px 10px;
            border-left: 1px solid #ddd;
            overflow-y: auto; 
            max-height: 550px; 
        }

        .record-header {
            font-weight: 700;
            color: #34495e;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid #34495e;
            text-align: center;
        }

        /* 일별 기록 항목 스타일 */
        .daily-record-item {
            padding: 10px;
            margin-bottom: 8px;
            background-color: #ffffff;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            cursor: pointer; 
            transition: background-color 0.15s;
            text-align: left;
        }

        .daily-record-item:hover {
            background-color: #e0f0ff;
        }

        .daily-date {
            font-weight: bold;
            color: #2980b9;
            font-size: 1.1em;
            display: block;
            margin-bottom: 5px;
        }

        .daily-time {
            font-size: 0.9em;
            color: #27ae60;
            font-family: monospace;
        }

        /* --- 모달 (팝업) 스타일 --- */
        .modal {
            position: fixed; 
            z-index: 10;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4); 
            display: none; /* JS로 제어 */
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto; 
            padding: 30px;
            border-radius: 10px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            text-align: left;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close-button:hover,
        .close-button:focus {
            color: #333;
            text-decoration: none;
            cursor: pointer;
        }

        #modal-records-list .record-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }
        .record-label { font-weight: 600; }
        .record-time-detail { color: #27ae60; font-family: monospace; }
        .record-pause-detail { color: #e74c3c; font-family: monospace; }
        
        .back-link {
            margin-top: 30px;
        }
        .back-link a {
            color: #3498db; text-decoration: none; font-weight: 500;
        }
        .back-link a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    
    <h1>순공 시간 측정기</h1>
    
    <div class="timer-app-container">
        
        <div class="main-timer-section">
            <div id="total-study-display">총 공부 시간: 00:00:00</div>
            
            <div id="timer-display">00:00:00.00</div>
            
            <div id="timer-controls">
                <button id="start-button">시작</button>
                
                <div id="running-controls" style="display: none;">
                    <button id="stop-button">정지</button>
                    <button id="finish-button">끝내기</button>
                </div>
            </div>
            
            <div id="detail-modal" class="modal">
                <div class="modal-content">
                    <span class="close-button">&times;</span>
                    <h3><span id="modal-date-title"></span> 상세 기록</h3>
                    <div id="modal-records-list">
                        </div>
                </div>
            </div>
        </div>

        <div class="date-record-bar-section">
            <div class="record-header">누적 기록</div>
            <div id="daily-records-list">
                <p style="padding: 10px; font-size: 0.9em; color: #7f8c8d;">공부 세션을 완료하면 기록이 저장됩니다.</p>
            </div>
        </div>
    </div>
    
    <div class="back-link">
        <a href="index.html">메인 화면으로 돌아가기</a>
    </div>

    <script>
        // --- 상태 관리 변수 ---
        let startTime = 0;          
        let currentInterval = null; 
        let currentSectionTime = 0; 
        let totalElapsedTime = 0;   
        let isRunning = false;      
        let isPaused = false;       
        let sessionStartTime = null; 

        let currentSessionRecords = []; // 현재 세션의 상세 기록 (공부/정지 시간)
        const dailyRecordsKey = 'dailyStudyRecords'; // localStorage 키

        // DOM 요소 가져오기
        const timerDisplay = document.getElementById('timer-display');
        const totalStudyDisplay = document.getElementById('total-study-display');
        const startButton = document.getElementById('start-button');
        const stopButton = document.getElementById('stop-button');
        const finishButton = document.getElementById('finish-button');
        const runningControls = document.getElementById('running-controls');
        
        const modal = document.getElementById('detail-modal');
        const closeButton = document.querySelector('.close-button');

        // --- 유틸리티 함수 ---
        
        // 시:분:초.밀리초(0.01초) 형식
        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const hours = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
            const minutes = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
            const seconds = String(totalSeconds % 60).padStart(2, '0');
            const centiseconds = String(Math.floor((ms % 1000) / 10)).padStart(2, '0'); // 0.01초 단위
            return `${hours}:${minutes}:${seconds}.${centiseconds}`;
        }
        
        // 시:분:초 형식 (기록용)
        function formatSimpleTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const hours = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
            const minutes = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
            const seconds = String(totalSeconds % 60).padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }
        
        function getTodayDateString() {
            const now = new Date();
            // YYYY-MM-DD 형식으로 반환
            return now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');
        }

        // --- 기록 함수 ---
        
        // 현재 세션 상세 기록 배열에 저장
        function recordTime(label, timeMs, type = 'time') {
            const timeFormatted = type === 'pause' ? formatSimpleTime(timeMs) : (type === 'start' || type === 'finish' ? new Date().toLocaleTimeString('ko-KR') : formatSimpleTime(timeMs));
            
            currentSessionRecords.push({
                label: label,
                time: timeMs,
                formatted: timeFormatted,
                type: type,
                timestamp: Date.now()
            });
        }

        // --- 타이머 업데이트 함수 ---
        function updateTimer() {
            const now = Date.now();
            const elapsedSinceStart = now - startTime;
            
            currentSectionTime += elapsedSinceStart;
            totalElapsedTime += elapsedSinceStart;
            
            startTime = now; 
            
            timerDisplay.textContent = formatTime(currentSectionTime);
            totalStudyDisplay.textContent = `총 공부 시간: ${formatSimpleTime(totalElapsedTime)}`;
        }

        // --- LocalStorage 및 기록 바 관리 ---

        function loadDailyRecords() {
            const data = localStorage.getItem(dailyRecordsKey);
            return data ? JSON.parse(data) : {};
        }

        function renderDailyRecords() {
            const dailyRecords = loadDailyRecords();
            const list = document.getElementById('daily-records-list');
            list.innerHTML = '';
            
            const dates = Object.keys(dailyRecords).sort().reverse(); 

            if (dates.length === 0) {
                list.innerHTML = '<p style="padding: 10px; font-size: 0.9em; color: #7f8c8d;">기록 없음</p>';
                return;
            }

            dates.forEach(date => {
                const record = dailyRecords[date];
                const item = document.createElement('div');
                item.className = 'daily-record-item';
                item.dataset.date = date; 
                item.innerHTML = `
                    <span class="daily-date">${date}</span>
                    <span class="daily-time">순공: ${formatSimpleTime(record.totalStudyTime)}</span>
                `;
                item.addEventListener('click', () => showDetailModal(date));
                list.appendChild(item);
            });
        }

        function saveDailyRecord(totalTime, sessionRecords) {
            const today = getTodayDateString();
            const dailyRecords = loadDailyRecords();
            
            if (!dailyRecords[today]) {
                dailyRecords[today] = { totalStudyTime: 0, sessions: [] };
            }
            
            dailyRecords[today].totalStudyTime += totalTime;
            
            dailyRecords[today].sessions.push({
                studyTime: totalTime,
                records: sessionRecords
            });
            
            localStorage.setItem(dailyRecordsKey, JSON.stringify(dailyRecords));
            renderDailyRecords(); 
        }

        // --- 버튼 로직 ---

        function startTimer() {
            if (isRunning) return;

            if (!sessionStartTime) {
                sessionStartTime = Date.now();
                recordTime('세션 시작', 0, 'start');
            }
            
            isRunning = true;
            isPaused = false;
            
            startButton.style.display = 'none';
            runningControls.style.display = 'block';

            startTime = Date.now(); 
            currentInterval = setInterval(updateTimer, 10); 
        }

        function stopTimer(isFinish = false) {
            if (!isRunning) return;
            
            isRunning = false;
            isPaused = true;
            clearInterval(currentInterval);
            
            const pauseTime = Date.now();
            
            recordTime('공부 구간', currentSectionTime);
            currentSectionTime = 0; 

            if (isFinish) {
                // 최종 저장
                saveDailyRecord(totalElapsedTime, currentSessionRecords);
                
                recordTime('세션 종료', pauseTime - sessionStartTime, 'finish');
                
                // 상태 초기화
                sessionStartTime = null;
                totalElapsedTime = 0;
                currentSessionRecords = []; 
                isPaused = false;
                
                // 버튼 비활성화 (새 세션 시작을 위해 새로고침 유도)
                startButton.style.display = 'block';
                startButton.disabled = true;
                runningControls.style.display = 'none';
                
                timerDisplay.textContent = '00:00:00.00';
                totalStudyDisplay.textContent = '총 공부 시간: 00:00:00';
                alert(`공부 끝! 총 순공 시간이 기록되었습니다.`);
                
            } else {
                // 정지 버튼을 누르면, 다시 시작할 수 있도록 시작 버튼 활성화
                startButton.style.display = 'block';
                runningControls.style.display = 'none';
            }
        }
        
        // --- 페이지 가시성 제어 (다른 창으로 나가면 멈춤) ---
        let pageHiddenTime = 0; 
        
        function handleVisibilityChange() {
            if (!isRunning && !isPaused) return; 

            if (document.hidden) {
                if (isRunning) {
                    stopTimer(false); 
                    pageHiddenTime = Date.now();
                }
            } else {
                if (isPaused && sessionStartTime) { 
                    const now = Date.now();
                    const pauseDuration = now - pageHiddenTime;
                    
                    recordTime('정지 시간', pauseDuration, 'pause'); 
                    
                    startTimer(); 
                    isPaused = true; 
                }
            }
        }

        // --- 모달 제어 함수 ---
        
        function showDetailModal(date) {
            const dailyRecords = loadDailyRecords();
            const record = dailyRecords[date];
            const modalRecordsList = document.getElementById('modal-records-list');
            document.getElementById('modal-date-title').textContent = date;
            
            modalRecordsList.innerHTML = '';
            
            record.sessions.forEach((session, sessionIndex) => {
                const totalSessionTime = session.records.find(r => r.label === '공부 구간');
                
                modalRecordsList.innerHTML += `<h4>세션 ${sessionIndex + 1} (순공: ${formatSimpleTime(session.studyTime)})</h4>`;
                
                session.records.forEach(item => {
                    const timeClass = item.type === 'pause' ? 'record-pause-detail' : 'record-time-detail';
                    
                    let label = item.label;
                    let timeValue = item.formatted;
                    
                    modalRecordsList.innerHTML += `
                        <div class="record-item">
                            <span class="record-label">${label}</span>
                            <span class="${timeClass}">${timeValue}</span>
                        </div>
                    `;
                });
                modalRecordsList.innerHTML += '<hr>';
            });

            modal.style.display = 'block';
        }

        closeButton.onclick = function() {
            modal.style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }


        // --- 초기 로드 및 이벤트 리스너 ---
        
        // 페이지 로드 시 기존 기록을 불러와 우측 바에 표시
        document.addEventListener('DOMContentLoaded', renderDailyRecords);

        startButton.addEventListener('click', startTimer);
        stopButton.addEventListener('click', () => {
            stopTimer(false);
        });
        finishButton.addEventListener('click', () => stopTimer(true));
        
        document.addEventListener('visibilitychange', handleVisibilityChange);
    </script>
</body>
</html>
