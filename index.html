<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Charger Tomato Penguin - 인증 및 기능 선택</title>
    <style>
        /* --- 기본 레이아웃 및 폰트 --- */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            padding: 20px; 
            background-color: #f5f7fa; /* 더 밝고 부드러운 배경색 */
            text-align: center; 
        }
        .container { 
            max-width: 380px; /* 컨테이너 폭 더 좁게 */
            margin: 80px auto; /* 상단 여백 증가 */
            background: white; 
            padding: 35px; 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); /* 그림자 부드럽게 */
        }
        
        /* --- 인증 섹션 타이틀 (간결화) --- */
        h1 { 
            color: #34495e; 
            margin-bottom: 30px; 
            font-size: 1.6em; /* 제목 크기 */
            font-weight: 700;
        }
        
        /* --- 인증 상태 및 메시지 --- */
        #userStatus { 
            font-weight: 600; 
            margin-bottom: 25px; 
            padding: 10px; 
            background: #ecf0f1; /* 은은한 회색 배경 */
            color: #2c3e50;
            border-radius: 6px; 
        }
        
        /* --- 인증 폼 스타일 --- */
        .auth-section h3 {
            display: none; /* '로그인이 필요합니다' 문구는 h1으로 대체하고 숨김 */
        }
        input[type="text"], input[type="password"] { 
            width: 100%; 
            padding: 12px; 
            margin: 10px 0; 
            border: 1px solid #ccc; 
            border-radius: 6px; 
            box-sizing: border-box; 
        }
        
        /* --- 인증 버튼 --- */
        .auth-buttons {
            display: flex; 
            justify-content: space-between;
            margin-top: 20px;
        }
        .auth-buttons button { 
            width: 48%; 
            padding: 10px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-weight: bold; 
            transition: background-color 0.2s;
        }
        #signupBtn { 
            background-color: #27ae60; /* 더 진한 초록색 */
            color: white; 
        }
        #loginBtn { 
            background-color: #2980b9; /* 더 진한 파란색 */
            color: white; 
        }

        /* --- 기능 버튼 컨테이너 (로그인 후 대시보드) --- */
        .button-container { margin-top: 30px; display: flex; flex-direction: column; gap: 15px; }

        /* 기능 1 (타이머) 스타일 조정 */
        .feature-button {
            display: block;
            width: 100%;
            padding: 15px;
            background-color: #f39c12; /* 오렌지색 */
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            box-shadow: 0 4px 0 #e67e22; /* 3D 효과 추가 */
            transition: all 0.1s;
        }
        .feature-button:active {
             box-shadow: 0 1px 0 #e67e22;
             transform: translateY(3px);
        }

        /* 기능 2 (퀴즈) 스타일 조정 */
        .feature-execute-button {
            display: block;
            width: 100%;
            padding: 15px;
            background-color: #8e44ad; /* 보라색 */
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 0 #9b59b6; /* 3D 효과 추가 */
            transition: all 0.1s;
        }
        .feature-execute-button:active {
             box-shadow: 0 1px 0 #9b59b6;
             transform: translateY(3px);
        }
        
        /* 로그아웃 버튼 스타일 조정 */
        #logoutBtn { 
            background-color: #c0392b; /* 진한 빨간색 */
            color: white; 
            margin-top: 30px; 
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1 id="mainTitle">로그인이 필요합니다</h1>

        <div id="userStatus">인증 상태 확인 중...</div>

        <div id="authSection" class="auth-section" style="display: none;">
            <input type="text" id="usernameInput" placeholder="사용할 아이디"> 
            <input type="password" id="passwordInput" placeholder="비밀번호">
            <div class="auth-buttons">
                <button id="loginBtn">로그인</button>
                <button id="signupBtn">회원가입</button>
            </div>
        </div>

        <div id="dashboardSection" style="display: none;">
            
            <div class="button-container">
                <a href="timer.html" class="feature-button">기능 1 (순공 시간 타이머)</a>
                <button onclick="goToFeature2()" class="feature-execute-button">기능 2 (History Quiz) 실행</button>
            </div>
            
            <button id="logoutBtn">로그아웃</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    
    <script>
        // --- Firebase 설정 (원본 유지) ---
        const firebaseConfig = {
            apiKey: "AIzaSyB_nt4nzPfp-trlT8QHNFPFpd-oKqfyWGo",
            authDomain: "penguineatpenguin.firebaseapp.com",
            projectId: "penguineatpenguin",
            storageBucket: "penguineatpenguin.firebasestorage.app",
            messagingSenderId: "757747390049",
            appId: "1:757747390049:web:72bcdc12d5eb3bc1b97c20",
            measurementId: "G-XCT650Z39X"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const PROJECT_ID = firebaseConfig.projectId; 

        // --- DOM 요소 ---
        const usernameInput = document.getElementById('usernameInput'); 
        const passwordInput = document.getElementById('passwordInput');
        const signupBtn = document.getElementById('signupBtn');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const userStatus = document.getElementById('userStatus');
        const authSection = document.getElementById('authSection');
        const dashboardSection = document.getElementById('dashboardSection');
        const mainTitle = document.getElementById('mainTitle'); // 새로 추가

        // --- [핵심 함수] 아이디를 Firebase용 가상 이메일로 변환 ---
        function convertUsernameToEmail(username) {
            const sanitizedUsername = username.toLowerCase().replace(/[^a-z0-9]/g, '_');
            return `${sanitizedUsername}@${PROJECT_ID}.com`;
        }
        function goToFeature2() {
            window.location.href = 'history quiz.html'; 
        }

        // --- 인증 상태 변경 감지 및 UI 업데이트 ---
        auth.onAuthStateChanged((user) => {
            if (user) {
                // 로그인됨: 닉네임 표시 및 제목 변경
                const displayId = user.displayName; 
                userStatus.textContent = `환영합니다, ${displayId}님!`;
                mainTitle.textContent = "기능을 선택하세요."; // 제목 변경
                authSection.style.display = 'none';
                dashboardSection.style.display = 'block';
            } else {
                // 로그아웃됨: 로그인/회원가입 영역 표시 및 제목 변경
                userStatus.textContent = '아이디와 비밀번호를 입력해주세요.';
                mainTitle.textContent = "로그인이 필요합니다"; // 제목 변경
                authSection.style.display = 'block';
                dashboardSection.style.display = 'none';
            }
        });

        // --- 1. 회원가입 핸들러 (아이디 기반) ---
        signupBtn.addEventListener('click', () => {
            const username = usernameInput.value.trim();
            const password = passwordInput.value;
            
            if (!username) { alert("사용할 아이디를 입력해주세요."); return; }
            if (password.length < 6) { alert("비밀번호는 6자리 이상이어야 합니다."); return; }
            
            const emailToUse = convertUsernameToEmail(username);

            auth.createUserWithEmailAndPassword(emailToUse, password)
                .then((userCredential) => {
                    return userCredential.user.updateProfile({ displayName: username });
                })
                .then(() => {
                    alert(`회원가입 및 로그인 성공! 아이디: ${username}`);
                })
                .catch((error) => {
                    console.error("회원가입 오류:", error.code, error.message);
                    if (error.code === 'auth/email-already-in-use') {
                        alert(`회원가입 실패: 이미 사용 중인 아이디입니다.`);
                    } else {
                        alert(`회원가입 실패: ${error.message}`);
                    }
                });
        });

        // --- 2. 로그인 핸들러 (아이디 기반) ---
        loginBtn.addEventListener('click', () => {
            const username = usernameInput.value.trim();
            const password = passwordInput.value;

            if (!username || !password) { alert("아이디와 비밀번호를 모두 입력해주세요."); return; }

            const emailToUse = convertUsernameToEmail(username); 

            auth.signInWithEmailAndPassword(emailToUse, password)
                .then((userCredential) => {
                    alert("로그인 성공!");
                })
                .catch((error) => {
                    console.error("로그인 오류:", error.code, error.message);
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-email') {
                        alert(`로그인 실패: 아이디 또는 비밀번호가 올바르지 않습니다.`);
                    } else {
                        alert(`로그인 실패: ${error.message}`);
                    }
                });
        });

        // --- 3. 로그아웃 핸들러 ---
        logoutBtn.addEventListener('click', () => {
            auth.signOut()
                .then(() => { alert("로그아웃되었습니다."); })
                .catch((error) => { console.error("로그아웃 오류:", error); });
        });
    </script>
</body>
</html>
